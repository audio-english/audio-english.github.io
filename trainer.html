<html>
<head>
    <link href="https://res.cloudinary.com/finnhvman/raw/upload/matter/matter-0.2.2.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <script type="text/javascript" src="./dist/bundle.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <style>
        play-btn {
            width: 25px;
            height: 25px;
        }

        .trainer-table .aud-inline {
            display: none;
            margin-top: 4px;
        }

        .trainer-table td.comment {
            position: relative;
        }

        .selected-row {
            opacity: 0.4;
        }

        .page-link {
            min-width: 100px;
        }

        body {
            font-family: 'Open Sans', sans-serif;
        }

        .trainer-table .row-id {
            display: block;
        }

    </style>
</head>
<body>
<div class="container text-center my-4">

    <div id="pages" style="display: flex; flex-wrap: wrap;">

    </div>

    <!-- Table  -->
    <table class="trainer-table">
        <thead class="thead-ctrl">
        <tr>
            <th colspan="3">
                <div class="tcontrols">
                    <h3 class="ttitle"></h3>
                    <div>
                        <label class="matter-switch">
                            <input id="enshow" type="checkbox" role="switch" checked>
                            <span>English</span>
                        </label>
                    </div>
                    <div>
                        <label class="matter-switch">
                            <input id="rushow" type="checkbox" role="switch" checked>
                            <span>Русский</span>
                        </label>
                    </div>
                    <div>
                        <label class="matter-switch">
                            <input id="comshow" type="checkbox" role="switch" checked>
                            <span>Комментарии</span>
                        </label>
                    </div>
                </div>
            </th>
        </tr>
        </thead>
        <!-- Table head -->

        <!-- Table body -->
        <tbody id="demo">


        </tbody>
        <!-- Table body -->
    </table>
    <!-- Table  -->

    <div id="page">
    </div>

    <button id="export_btn" type="button" style="position: fixed; bottom: 30px; right: 10px;" hidden="hidden" />

    <button id="export_all_btn" type="button" style="position: fixed; bottom: 10px; right: 10px;">Export All</button>

    <div id="export-dialog" hidden="hidden">
        Copy the bellow text:
        <textarea readonly style="font-size: 10px; display: block; width: 100%;">
At w3schools.com you will learn how to make a website. We offer free tutorials in all web development technologies.
</textarea>
    </div>

</div>

<script type="text/javascript">

  $(document).ready(function(e) {
    $("#export-dialog").dialog({
      'title': 'Copy the code below',
      autoOpen: false
    });
    $("#export_btn").click(exportRows);
    $("#export_all_btn").click(() => exportRows(true))
  });

  function exportRows(all) {
    let fullHtml = `<table class="trainer-table">`;
    fullHtml += $('.thead-ctrl').html();
    const selector =
      $(all === true ? '.entry-row' : '.selected-row').each(function() {
        fullHtml += this.outerHTML;
      });
    fullHtml += `</tbody></table>`;
    $('#export-dialog textarea').val(fullHtml).select();
    $('#export-dialog').dialog('open');
  }


  $.getJSON("https://spreadsheets.google.com/feeds/list/1q59xaSiRIoITL1sCcTITGHDJX07YUVe6CZvkPqYnql4/od6/public/values?alt=json", function(data) {
    const map = {};
    for (const [i, entry] of data.feed.entry.entries()) {
      const key = text(entry, 'urok');
      map[key] = map[key] || [];
      entry.rowNum = i+2;
      map[key].push(entry)
    }
    for (const k of Object.keys(map).sort()) {
      $("#pages").append(`
    <div class="page-link"><a href="#${k}">${k}</a></div>
    `)
    }

    console.log(data);
    console.log(map);
    $("#pages a").click(function(e) {
      renderEntries(map[$(this).text()])
    });

    renderEntries(map[Object.keys(map)[0]])
  });

  function renderEntries(entries) {
    $("#demo").html("");
    for (const entry of entries) {
      $("#demo").append(renderEntry(entry));
    }
    $(".trainer-table td").click(function(e) {
      if (event.ctrlKey || event.metaKey) return;
      $(this).toggleClass('hide-text')
    });
    $(".trainer-table .play-btn").click(function(e) {
      const audio_id = $(this).attr('audio');
      playAudio(audio_id);
      e.stopPropagation()
    });
    $(".trainer-table tr").click(function(e) {
      if (event.ctrlKey || event.metaKey) {
        const eid = $(this).attr('eid');
        $(`tr[eid='${eid}']`).toggleClass('selected-row');

        const selectedCount = $(".selected-row").length / 2;
        if (selectedCount) {
          $('#export_btn').text(`Export ${selectedCount} entries`).show()
        } else {
          $('#export_btn').hide()
        }
      }
    })
  }

  function renderEntry(entry) {
    const isFreqWord = entry.gsx$freqdic && entry.gsx$freqdic.$t === 'TRUE';
    const eid = entryId(entry);
    return `
  <tr class="entry-row entry-top-row ${isFreqWord ? 'freqword' : ''}" eid="entry-${eid}">
  	<td class="aud eng-aud ${isFreqWord ? 'freqword' : ''}">
    	 ${renderPlayer(entry)}
    </td>
  	<td class="eng ${isFreqWord ? 'freqword' : ''}">
    	${isFreqWord ? `<div class="aud-inline">${renderPlayer(entry)}</div>` : ''}
    	${renderRichText(text(entry, 'eng'))}
      ${!isFreqWord ? `<div class="aud-inline">${renderPlayer(entry)}</div>` : ''}
    </td>
    <td class="comment ${isFreqWord ? 'freqword' : ''}" rowspan="2">
    	<div class="row-id" style="position: absolute; top: 0; right: 0;">${entry.rowNum}</div>
    	${renderRichText(text(entry, 'comment'))}</td>
  </tr>
  <tr class="entry-row entry-bottom-row ${isFreqWord ? 'freqword' : ''}" eid="entry-${eid}">
    <td class="aud rus-aud ${isFreqWord ? 'freqword' : ''}"></td>
  	<td class="rus ${isFreqWord ? 'freqword' : ''}">
    	${renderRichText(text(entry, 'rus'))}
    </td>
  </tr>
  `
  }

  function entryId(entry) {
    const id = entry.id.$t;
    return id.slice(id.length - 9)
  }

  function text(entry, columnName) {
    const cell = entry[`gsx$${columnName}`];
    if (cell) {
      return cell.$t;
    } else {
      return "";
    }
  }

  function renderPlayer(entry) {
    const isFreqWord = entry.gsx$freqdic && entry.gsx$freqdic.$t === 'TRUE';
    let result = '';
    if (text(entry, 'a1')) {
      result += `<play-btn class="${!isFreqWord ? 'solid' : ''}" src="${text(entry, 'a1')}"></play-btn> `
    }
    if (text(entry, 'a2')) {
      result += `<play-btn class="solid slow" src="${text(entry, 'a2')}"></play-btn>`
    }
    return result;
  }

  function renderRichText(text) {
    return `
  	<div class="rich">${text}</div>
  `
  }

</script>

</body>
</html>